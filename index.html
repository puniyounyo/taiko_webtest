<!DOCTYPE html>
<html>
<head>
  <title>太鼓入力デバイス設定</title>
</head>
<body>
  <h1>太鼓入力デバイス設定</h1>

  <p>se0: <span id="se0"></span></p>
  <p>se1: <span id="se1"></span></p>
  <p>se2: <span id="se2"></span></p>
  <p>se3: <span id="se3"></span></p>
  <p>A: <span id="A"></span></p>
  <p>B: <span id="B"></span></p>
  <p>C: <span id="C"></span></p>
  <p>p1: <span id="p1"></span></p>
  <p>ha: <span id="ha"></span></p>

  <h2>設定変更</h2>
  <form id="settingsForm">
    <label for="se0Input">se0:</label>
    <input type="range" id="se0Input" name="se0" min="0" max="255">
    <span id="se0Value"></span><br>

    <label for="se1Input">se1:</label>
    <input type="range" id="se1Input" name="se1" min="0" max="255">
    <span id="se1Value"></span><br>

    <label for="se2Input">se2:</label>
    <input type="range" id="se2Input" name="se2" min="0" max="255">
    <span id="se2Value"></span><br>

    <label for="se3Input">se3:</label>
    <input type="range" id="se3Input" name="se3" min="0" max="255">
    <span id="se3Value"></span><br>

    <label for="AInput">A:</label>
    <input type="range" id="AInput" name="A" min="0" max="255">
    <span id="AValue"></span><br>

    <label for="BInput">B:</label>
    <input type="range" id="BInput" name="B" min="0" max="255">
    <span id="BValue"></span><br>

    <label for="CInput">C:</label>
    <input type="range" id="CInput" name="C" min="0" max="255">
    <span id="CValue"></span><br>

    <label for="p1Input">p1:</label>
    <input type="range" id="p1Input" name="p1" min="0" max="255">
    <span id="p1Value"></span><br>

    <label for="haInput">ha:</label>
    <input type="range" id="haInput" name="ha" min="0" max="255">
    <span id="haValue"></span><br>

    <button type="button" id="applyButton">適用</button>
  </form>

  <script>
    let port;

    function displaySettings(settings) {
      document.getElementById("se0").textContent = settings.se0;
      document.getElementById("se1").textContent = settings.se1;
      document.getElementById("se2").textContent = settings.se2;
      document.getElementById("se3").textContent = settings.se3;
      document.getElementById("A").textContent = settings.A;
      document.getElementById("B").textContent = settings.B;
      document.getElementById("C").textContent = settings.C;
      document.getElementById("p1").textContent = settings.p1;
      document.getElementById("ha").textContent = settings.ha;

      document.getElementById("se0Input").value = settings.se0;
      document.getElementById("se1Input").value = settings.se1;
      document.getElementById("se2Input").value = settings.se2;
      document.getElementById("se3Input").value = settings.se3;
      document.getElementById("AInput").value = settings.A;
      document.getElementById("BInput").value = settings.B;
      document.getElementById("CInput").value = settings.C;
      document.getElementById("p1Input").value = settings.p1;
      document.getElementById("haInput").value = settings.ha;

      // スライドバーの横に値を表示
      document.getElementById("se0Value").textContent = settings.se0;
      document.getElementById("se1Value").textContent = settings.se1;
      document.getElementById("se2Value").textContent = settings.se2;
      document.getElementById("se3Value").textContent = settings.se3;
      document.getElementById("AValue").textContent = settings.A;
      document.getElementById("BValue").textContent = settings.B;
      document.getElementById("CValue").textContent = settings.C;
      document.getElementById("p1Value").textContent = settings.p1;
      document.getElementById("haValue").textContent = settings.ha;
    }

    function receiveData() {
      port.transferIn(1, 64).then(result => {
        const decoder = new TextDecoder();
        const jsonString = decoder.decode(result.data);
        const settings = JSON.parse(jsonString);
        displaySettings(settings);
      });
    }

    document.getElementById("applyButton").addEventListener("click", () => {
      const form = document.getElementById("settingsForm");
      const formData = new FormData(form);
      const settings = {};
      formData.forEach((value, key) => {
        settings[key] = parseInt(value);
      });
      const jsonString = JSON.stringify(settings);
      const encoder = new TextEncoder();
      const data = encoder.encode(jsonString);
      port.transferOut(1, data).then(() => {
        receiveData();
      });
    });

    navigator.usb.requestPort().then(selectedPort => {
      port = selectedPort;
      port.open().then(() => {
        receiveData();
      });
    });

    // スライドバーの値をリアルタイムに表示
    document.getElementById("se0Input").addEventListener("input", () => {
      document.getElementById("se0Value").textContent = document.getElementById("se0Input").value;
    });
    document.getElementById("se1Input").addEventListener("input", () => {
      document.getElementById("se1Value").textContent = document.getElementById("se1Input").value;
    });
    document.getElementById("se2Input").addEventListener("input", () => {
      document.getElementById("se2Value").textContent = document.getElementById("se2Input").value;
    });
    document.getElementById("se3Input").addEventListener("input", () => {
      document.getElementById("se3Value").textContent = document.getElementById("se3Input").value;
    });
    document.getElementById("AInput").addEventListener("input", () => {
      document.getElementById("AValue").textContent = document.getElementById("AInput").value;
    });
    document.getElementById("BInput").addEventListener("input", () => {
      document.getElementById("BValue").textContent = document.getElementById("BInput").value;
    });
    document.getElementById("CInput").addEventListener("input", () => {
      document.getElementById("CValue").textContent = document.getElementById("CInput").value;
    });
    document.getElementById("p1Input").addEventListener("input", () => {
      document.getElementById("p1Value").textContent = document.getElementById("p1Input").value;
    });
    document.getElementById("haInput").addEventListener("input", () => {
      document.getElementById("haValue").textContent = document.getElementById("haInput").value;
    });
  </script>
</body>
</html>
